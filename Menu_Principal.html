<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Series | Leno Style</title>

  <!-- Estilos base del tema Leno -->
  <link rel="stylesheet" href="css/bootstrap.css">
  <link rel="stylesheet" href="css/fontawesome-all.css">
  <link rel="stylesheet" href="css/styles.css">

  <!-- Fuente moderna -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
   /* =================== FUENTE GLOBAL =================== */
body {
  font-family: 'Poppins', sans-serif;
  background-color: #f8fafc;
  color: #2d3748;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* =================== ENCABEZADO STICKY =================== */
.header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(90deg, #00bfd8 0%, #0072ff 100%);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
  z-index: 1100;
  padding: 8px 20px;
}

/* Contenedor interno reorganizado */
.header .header-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  width: 100%;
}

/* Fila superior: Título + Botones */
.header-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

/* Zona izquierda (Título reducido) */
.header .left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.logo-text {
  font-size: 1.1rem;
  color: #ffffff;
  font-weight: 600;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

/* Zona derecha (Botones compactos) */
.header .right {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* Botones compactos */
.btn-service {
  background: #28a745;
  color: #ffffff;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 20px;
  border: none;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.25s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
}

.btn-service:hover {
  background: #218838;
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-service.cloudflare {
  background: #ff6b35;
}

.btn-service.cloudflare:hover {
  background: #e55a2b;
}

/* Botón cerrar sesión compacto */
.btn-solid-sm {
  background: #dc3545;
  color: #ffffff;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: 20px;
  border: none;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
  transition: all 0.25s ease;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
  text-decoration: none;
}

.btn-solid-sm:hover {
  background: #b02a37;
  transform: scale(1.05);
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  color: #ffffff;
  text-decoration: none;
}

/* Indicador de servicio activo compacto */
.service-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-left: 8px;
  font-size: 0.7rem;
  color: #fff;
  background: rgba(255, 255, 255, 0.2);
  padding: 3px 8px;
  border-radius: 15px;
  backdrop-filter: blur(10px);
}

.service-indicator i {
  font-size: 0.75rem;
}

/* Fila inferior: Filtros */
.header-bottom {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
}

.filtros-inline {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 4px 0;
}

/* Inputs y selects estilo Leno compactos */
.leno-select,
.leno-input {
  border-radius: 20px;
  border: 2px solid rgba(255, 255, 255, 0.18);
  background: rgba(255, 255, 255, 0.95);
  padding: 6px 12px;
  font-size: 0.85rem;
  color: #1f2937;
  min-width: 150px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
}

.leno-select:focus,
.leno-input:focus {
  border-color: rgba(255, 255, 255, 0.95);
  outline: none;
  box-shadow: 0 0 0 3px rgba(0, 191, 216, 0.12);
}

/* Icono del título */
.logo-text .fa-film {
  font-size: 0.9rem;
  opacity: 0.95;
}

/* =================== CONTENIDO PRINCIPAL =================== */
.main-content {
  margin-top: 100px;
  padding: 18px;
}

/* =================== TARJETAS (CARDS) =================== */
.series-grid {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 30px;
  padding: 20px;
  margin-top: 10px;
}

/* Card individual */
.serie-card {
  background: #fff;
  border-radius: 20px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  width: 270px;
  transition: all 0.3s ease;
  text-align: center;
}

.serie-card:hover {
  transform: translateY(-10px);
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
}

/* Imagen */
.serie-card img {
  width: 100%;
  height: 350px;
  object-fit: cover;
}

/* Contenido */
.serie-info {
  padding: 20px;
}

.serie-info h3 {
  color: #0072ff;
  font-weight: 700;
  font-size: 1.3rem;
}

.serie-info p {
  color: #555;
  margin-bottom: 10px;
}

/* Botón ver */
.btn-ver {
  background: linear-gradient(90deg, #00bfd8 0%, #0072ff 100%);
  border: none;
  border-radius: 50px;
  padding: 10px 25px;
  color: #fff;
  font-weight: 600;
  transition: all 0.3s ease;
  display: inline-block;
  text-decoration: none;
}

.btn-ver:hover {
  transform: scale(1.05);
}

/* =================== RESPONSIVE =================== */
@media (max-width: 1100px) {
  .leno-select,
  .leno-input {
    min-width: 140px;
  }
}

@media (max-width: 900px) {
  .header {
    padding: 6px 16px;
  }
  
  .logo-text {
    font-size: 1rem;
  }
  
  .btn-solid-sm, .btn-service {
    padding: 5px 10px;
    font-size: 0.75rem;
  }
  
  .service-indicator {
    font-size: 0.65rem;
    padding: 2px 6px;
  }
}

@media (max-width: 768px) {
  .header .header-row {
    gap: 6px;
  }
  
  .header-top {
    flex-wrap: wrap;
    gap: 8px;
  }
  
  .header .left {
    flex: 1;
  }
  
  .header .right {
    justify-content: flex-end;
  }
  
  .filtros-inline {
    justify-content: flex-start;
    padding-left: 0;
  }
  
  .leno-select,
  .leno-input {
    min-width: 130px;
    font-size: 0.8rem;
    padding: 5px 10px;
  }
  
  .main-content {
    margin-top: 110px;
  }
}

@media (max-width: 640px) {
  .header {
    padding: 5px 12px;
  }
  
  .logo-text {
    font-size: 0.95rem;
  }
  
  .btn-solid-sm, .btn-service {
    padding: 4px 8px;
    font-size: 0.7rem;
  }
  
  .service-indicator {
    font-size: 0.6rem;
    padding: 2px 5px;
  }
  
  .filtros-inline {
    gap: 6px;
  }
  
  .leno-select,
  .leno-input {
    min-width: 120px;
    font-size: 0.75rem;
  }
  
  .main-content {
    margin-top: 115px;
  }
}

@media (max-width: 480px) {
  .header-top {
    flex-direction: column;
    align-items: stretch;
    gap: 6px;
  }
  
  .header .left {
    justify-content: center;
  }
  
  .header .right {
    justify-content: center;
  }
  
  .filtros-inline {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .leno-select,
  .leno-input {
    min-width: 45%;
    flex: 1;
  }
  
  .main-content {
    margin-top: 140px;
  }
}

  </style>
</head>

<body>
 <!-- Encabezado reorganizado y compacto -->
<header id="header" class="header">
  <div class="container header-row">
    <!-- Fila superior: Título + Botones compactos -->
    <div class="header-top">
      <!-- IZQUIERDA: Título reducido -->
      <div class="left">
        <h1 class="logo-text m-0 fw-bold text-white">
          <i class="fas fa-film"></i> Series
        </h1>
        <span id="serviceIndicator" class="service-indicator">
          <i class="fas fa-database"></i> Firebase
        </span>
      </div>

      <!-- DERECHA: Botones compactos -->
      <div class="right">
        <button id="toggleService" class="btn-service">
          <i class="fas fa-exchange-alt"></i> Cambiar servicio
        </button>
        <a href="index.html" class="btn-solid-sm">
          <i class="fas fa-sign-out-alt"></i> Salir
        </a>
      </div>
    </div>

    <!-- Fila inferior: Filtros -->
    <div class="header-bottom">
      <div class="filtros-inline">
        <select id="menuSeries" class="leno-select">
          <option value="">Todas las series</option>
        </select>

        <input type="text" id="buscador" class="leno-input" placeholder="Buscar...">

        <select id="ordenar" class="leno-select">
          <option value="az">Orden A-Z</option>
          <option value="za">Orden Z-A</option>
        </select>
      </div>
    </div>
  </div>
</header>

<!-- Contenido principal (con margen-top para el header fijo) -->
<main class="main-content container">
  <div class="series-grid" id="contenedorSeries"></div>
</main>

  <!-- Scripts base del tema Leno -->
  <script src="js/jquery.min.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script src="js/custom.js"></script>

  <!-- Lógica Firebase, Cloudflare y renderizado -->
  <script>
  // Configuración de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB6MY2y5uyum87PdUHUpY8NNh4D73Yhx4U",
    authDomain: "animes-plus-89b93.firebaseapp.com",
    projectId: "animes-plus-89b93",
    storageBucket: "animes-plus-89b93.appspot.com",
    messagingSenderId: "402867181985",
    appId: "1:402867181985:web:d695b12977fe4270dbd3e0",
    measurementId: "G-DN632G7XJT"
  };

  // Configuración de Cloudflare
  const CLOUDFLARE_ENDPOINT = 'https://proyecto-cloudflare.apiprueba2025.workers.dev';

  // Estado de la aplicación
  let servicioActivo = 'firebase'; // 'firebase' o 'cloudflare'
  let todasLasSeries = [];
  let nombresUnicos = new Set();
  const ITEMS_POR_PAGINA = 9;
  let currentPage = 1;

  // Inicializar Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Función para cambiar entre servicios
  function toggleServicio() {
    if (servicioActivo === 'firebase') {
      servicioActivo = 'cloudflare';
      document.getElementById('toggleService').innerHTML = '<i class="fas fa-exchange-alt"></i> Cambiar servicio';
      document.getElementById('toggleService').classList.add('cloudflare');
      document.getElementById('serviceIndicator').innerHTML = '<i class="fas fa-cloud"></i> Cloudflare';
    } else {
      servicioActivo = 'firebase';
      document.getElementById('toggleService').innerHTML = '<i class="fas fa-exchange-alt"></i> Cambiar servicio';
      document.getElementById('toggleService').classList.remove('cloudflare');
      document.getElementById('serviceIndicator').innerHTML = '<i class="fas fa-database"></i> Firebase';
    }
    
    // Recargar datos con el nuevo servicio
    currentPage = 1;
    cargarSeries();
  }

  // Función para cargar series según el servicio activo
  async function cargarSeries() {
    if (servicioActivo === 'firebase') {
      await cargarSeriesFirebase();
    } else {
      await cargarSeriesCloudflare();
    }
  }

  // Función para cargar series desde Firebase
  async function cargarSeriesFirebase() {
    try {
      const snapshotSeries = await db.collection("animes-series-portadas").get();
      const datosTemporales = [];

      for (const docSerie of snapshotSeries.docs) {
        const nombreSerie = docSerie.id;
        nombresUnicos.add(nombreSerie);

        const snapshotTemporadas = await db.collection("animes-series-portadas")
          .doc(nombreSerie).collection("Temporadas").get();

        snapshotTemporadas.forEach(docTemporada => {
          const temporadaCompleta = docTemporada.id; // Esto ya incluye "Temporada 01 - Sub Español"
          const data = docTemporada.data();
          const imagen = data.imagen || "https://via.placeholder.com/300x400?text=Sin+Imagen";
          
          // IMPORTANTE: Ya NO extraemos idioma separado porque ya está en "temporadaCompleta"
          // El formato ya es: "Temporada 01 - Sub Español"
          
          // Crear URL para el reproductor universal
          // Enviamos la temporada completa como está
          const sitio = `reproductor_universal.html?serie=${encodeURIComponent(nombreSerie)}&temporada=${encodeURIComponent(temporadaCompleta)}`;

          datosTemporales.push({
            nombre: nombreSerie,
            temporadaCompleta: temporadaCompleta, // "Temporada 01 - Sub Español"
            imagen: imagen,
            sitio: sitio
          });
        });
      }

      todasLasSeries = datosTemporales;
      poblarMenuSeries();
      renderizarSeries();
    } catch (error) {
      console.error("Error cargando desde Firebase:", error);
      // Si hay error, intentar con Cloudflare
      if (servicioActivo === 'firebase') {
        alert("Error al conectar con Firebase. Cambiando a Cloudflare...");
        toggleServicio();
      }
    }
  }

  // Función para cargar series desde Cloudflare
  async function cargarSeriesCloudflare() {
    try {
      const response = await fetch(`${CLOUDFLARE_ENDPOINT}/portadas`);
      
      if (!response.ok) {
        throw new Error(`Error HTTP: ${response.status}`);
      }
      
      const portadas = await response.json();
      const datosTemporales = [];

      // Procesar datos de Cloudflare
      portadas.forEach(portada => {
        const nombreSerie = portada.nombreSerie;
        nombresUnicos.add(nombreSerie);
        
        // En Cloudflare también asumimos que ya viene con idioma
        const temporadaCompleta = portada.temporada; // "Temporada 01 - Sub Español"
        
        // Crear URL para el reproductor universal
        const sitio = `reproductor_universal.html?serie=${encodeURIComponent(nombreSerie)}&temporada=${encodeURIComponent(temporadaCompleta)}`;
        
        datosTemporales.push({
          nombre: nombreSerie,
          temporadaCompleta: temporadaCompleta, // "Temporada 01 - Sub Español"
          imagen: portada.imagen || "https://via.placeholder.com/300x400?text=Sin+Imagen",
          sitio: sitio
        });
      });

      todasLasSeries = datosTemporales;
      poblarMenuSeries();
      renderizarSeries();
    } catch (error) {
      console.error("Error cargando desde Cloudflare:", error);
      // Si hay error, intentar con Firebase
      if (servicioActivo === 'cloudflare') {
        alert("Error al conectar con Cloudflare. Cambiando a Firebase...");
        toggleServicio();
      }
    }
  }

  function poblarMenuSeries() {
    const select = document.getElementById("menuSeries");
    select.innerHTML = '<option value="">Todas las series</option>';
    
    [...nombresUnicos].sort().forEach(nombre => {
      const opcion = document.createElement("option");
      opcion.value = nombre;
      opcion.textContent = nombre;
      select.appendChild(opcion);
    });
  }

  function renderizarSeries() {
    const contenedor = document.getElementById("contenedorSeries");
    contenedor.innerHTML = "";

    const filtroNombre = document.getElementById("buscador").value.toLowerCase();
    const filtroSeleccionado = document.getElementById("menuSeries").value;
    const orden = document.getElementById("ordenar").value;

    let filtradas = todasLasSeries.filter(s => {
      const coincideTexto = s.nombre.toLowerCase().includes(filtroNombre);
      const coincideSeleccion = !filtroSeleccionado || s.nombre === filtroSeleccionado;
      return coincideTexto && coincideSeleccion;
    });

    filtradas.sort((a, b) => {
      if (orden === "az") return a.nombre.localeCompare(b.nombre);
      else return b.nombre.localeCompare(a.nombre);
    });

    // Paginación
    const totalPaginas = Math.ceil(filtradas.length / ITEMS_POR_PAGINA);
    if (currentPage > totalPaginas) currentPage = 1;

    const inicio = (currentPage - 1) * ITEMS_POR_PAGINA;
    const paginadas = filtradas.slice(inicio, inicio + ITEMS_POR_PAGINA);

    paginadas.forEach(serie => {
      const card = document.createElement("div");
      card.className = "serie-card";
      card.innerHTML = `
        <img src="${serie.imagen}" alt="Portada de ${serie.nombre}">
        <div class="serie-info">
          <h3>${serie.nombre}</h3>
          <p>${serie.temporadaCompleta}</p>
          <a class="btn-ver" href="${serie.sitio}">Ver</a>
        </div>
      `;
      contenedor.appendChild(card);
    });

    renderizarPaginacion(totalPaginas);
  }

  function renderizarPaginacion(totalPaginas) {
    const paginacionContenedor = document.getElementById("paginacion") || document.createElement("div");
    paginacionContenedor.id = "paginacion";
    paginacionContenedor.style.textAlign = "center";
    paginacionContenedor.style.marginTop = "30px";
    paginacionContenedor.style.display = "flex";
    paginacionContenedor.style.justifyContent = "center";
    paginacionContenedor.style.alignItems = "center";
    paginacionContenedor.style.gap = "15px";
    paginacionContenedor.innerHTML = "";

    const btnAnterior = document.createElement("button");
    btnAnterior.innerHTML = "&#8592;";
    btnAnterior.style.padding = "8px 14px";
    btnAnterior.style.borderRadius = "50%";
    btnAnterior.style.border = "none";
    btnAnterior.style.cursor = "pointer";
    btnAnterior.style.background = currentPage === 1 ? "#cbd5e0" : "#0072ff";
    btnAnterior.style.color = "#fff";
    btnAnterior.disabled = currentPage === 1;
    btnAnterior.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage--;
        renderizarSeries();
      }
    });

    const texto = document.createElement("span");
    texto.textContent = `Página ${String(currentPage).padStart(2, '0')} - ${String(totalPaginas).padStart(2, '0')}`;
    texto.style.fontWeight = "600";
    texto.style.color = "#2d3748";

    const btnSiguiente = document.createElement("button");
    btnSiguiente.innerHTML = "&#8594;";
    btnSiguiente.style.padding = "8px 14px";
    btnSiguiente.style.borderRadius = "50%";
    btnSiguiente.style.border = "none";
    btnSiguiente.style.cursor = "pointer";
    btnSiguiente.style.background = currentPage === totalPaginas ? "#cbd5e0" : "#0072ff";
    btnSiguiente.style.color = "#fff";
    btnSiguiente.disabled = currentPage === totalPaginas;
    btnSiguiente.addEventListener("click", () => {
      if (currentPage < totalPaginas) {
        currentPage++;
        renderizarSeries();
      }
    });

    paginacionContenedor.appendChild(btnAnterior);
    paginacionContenedor.appendChild(texto);
    paginacionContenedor.appendChild(btnSiguiente);

    if (!document.getElementById("paginacion")) {
      document.querySelector(".main-content").appendChild(paginacionContenedor);
    }
  }

  // Event Listeners
  document.getElementById("toggleService").addEventListener("click", toggleServicio);
  document.getElementById("buscador").addEventListener("input", () => {
    currentPage = 1;
    renderizarSeries();
  });
  document.getElementById("menuSeries").addEventListener("change", () => {
    currentPage = 1;
    renderizarSeries();
  });
  document.getElementById("ordenar").addEventListener("change", () => {
    currentPage = 1;
    renderizarSeries();
  });

  // Cargar datos iniciales
  cargarSeries();
</script>
</body>
</html>